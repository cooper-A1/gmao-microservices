upstream machines_service {
    server machines-service:8001;
}

upstream interventions_service {
    server interventions-service:8002;
}

upstream techniciens_service {
    server techniciens-service:8003;
}

upstream stock_service {
    server stock-service:8004;
}

# upstream prediction_service {
#     server prediction-service:8005;
# }

# Configuration du serveur principal
server {
    listen 80;
    server_name localhost;
    
    # Configuration des logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Configuration CORS globale
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
    
    # Gestion des requêtes OPTIONS (preflight)
    location / {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
    
    # Page d'accueil de l'API Gateway
    location = / {
        return 200 '{"service":"GMAO API Gateway","version":"1.0.0","status":"operational","services":[{"name":"machines","path":"/api/machines"},{"name":"interventions","path":"/api/interventions"},{"name":"techniciens","path":"/api/techniciens"},{"name":"stock","path":"/api/stock"},{"name":"prediction","path":"/api/prediction"}],"documentation":{"machines":"http://localhost/machines-docs","interventions":"http://localhost/interventions-docs","techniciens":"http://localhost/techniciens-docs","stock":"http://localhost/stock-docs"}}';
        add_header Content-Type application/json;
    }
    
    # Endpoint de santé global
    location /health {
        access_log off;
        return 200 '{"status":"healthy","gateway":"operational","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # Service Machines (Java Spring Boot)
    location /api/machines {
        proxy_pass http://machines_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Documentation Swagger pour Machines
    location /machines-docs {
        proxy_pass http://machines_service/swagger-ui.html;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Service Interventions (Python FastAPI)
    location /api/interventions {
        proxy_pass http://interventions_service/api/interventions;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Authentification pour Interventions
    location /api/auth {
        proxy_pass http://interventions_service/api/auth;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Documentation FastAPI pour Interventions
    location /interventions-docs {
        proxy_pass http://interventions_service/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Service Techniciens (Node.js Express)
    location /api/techniciens {
        proxy_pass http://techniciens_service/api/techniciens;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Documentation Swagger pour Techniciens
    location /techniciens-docs {
        proxy_pass http://techniciens_service/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Service Stock (Go Gin)
    location /api/stock {
        proxy_pass http://stock_service/api/stock;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Documentation Swagger pour Stock
    location /stock-docs {
        proxy_pass http://stock_service/swagger/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Service Prédiction IA (Bonus)
    # location /api/prediction {
    #     proxy_pass http://prediction_service/api/prediction;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_connect_timeout 30s;
    #     proxy_send_timeout 30s;
    #     proxy_read_timeout 30s;
    # }
    
    # Configuration pour les gros uploads
    client_max_body_size 10M;
    
    # Gestion des erreurs
    error_page 404 /404.json;
    error_page 500 502 503 504 /50x.json;
    
    location = /404.json {
        return 404 '{"error":"Endpoint non trouvé","message":"Vérifiez le chemin de votre requête"}';
        add_header Content-Type application/json;
    }
    
    location = /50x.json {
        return 500 '{"error":"Erreur interne","message":"Un service backend est temporairement indisponible"}';
        add_header Content-Type application/json;
    }
}